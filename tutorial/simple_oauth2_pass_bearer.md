<h3>Простой OAuth2 с паролем и Bearer</h3>

Теперь давайте отталкиваться от прошлой главы и добавим пропущенные части, чтобы иметь завершенный поток безопасности.

<h4>Получение `username` и `password`</h4>

Мы собираемся использовать утилиты безопасности FastAPI, чтобы получить `username` и `password`.

OAuth2 определяет, что когда используя "поток пароля" (что мы и делаем), клиент/пользователь должен отправлять поля
`username` и `password` как данные формы.

А спецификация говорит, что эти поля должны быть названы именно так. Поэтому `user-name` или `email` не будут работать.

Но не беспокойтесь, вы можете показать их так, как желаете, для конечных пользователей во фронтенде.

А ваши модели базы данных могут использовать любые имена, которые вы захотите. 

Но для операции пути **входа в систему**, нам нужно использовать эти названия, чтобы они были совместимыми со 
спецификацией (и были способны, например, использовать встроенную систему документации API).

Также, спецификация устанавливает, что `username` и `password` должны быть отправлены как данные формы (поэтому здесь не
JSON).

<h5>`scope`</h5>

Также, спецификация говорит, что клиент может отправить еще одно поле формы "`scope`".

Название поля формы - `scope` (в единственном числе), но на самом деле это длинная строка с "scopes", разделенными 
пробелами.

Каждый "scope" это просто строка (без пробелов).

Обычно они используются, чтобы объявлять определенные требования безопасности, например:
* `users:read` или `users:write` частые примеры.
* `instagram_basic` используется Facebook/Instagram.
* `https://www.googleapis.com/auth/drive` используется Google.

> **Для информации**
> 
> В OAuth2, "scope" это просто строка которая объявляет определенные требования допуска. 
> 
> Не важно есть ли в нем какие-то другие символы вроде `:` или если это URL.
> 
> Эти детали зависят от конкретной реализации.
> 
> Для OAuth2 все они просто строки.

<h4>Код чтобы получить `username` и `password`</h4>

Теперь давайте использовать утилиты предоставленные FastAPI, чтобы все это обработать.

<h5>`OAuth2PasswordRequestForm`</h5>

Сперва импортируем `OAuth2PasswordRequestForm` и используем ее как зависимость с `Depends` в операции пути для `/token`:

```python
from typing import Annotated

from fastapi import Depends, FastAPI, HTTPException, status
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
...

app = FastAPI()
...

@app.post("/token")
async def login(form_data: Annotated[OAuth2PasswordRequestForm, Depends()]):
    ...
```

`OAuth2PasswordRequestForm` это класс зависимости который объявляет форму тела запроса с:

* `username`.
* `password`.
* Необязательным полем `scope` как большая строка, составленной из строк, разделенных пробелами.
* Необязательным `grant_type`.

> **Совет**
> 
> На самом деле спецификация OAuth2 требует поле `grant_type` с установленным значением `password`, но 
> `OAuth2PasswordRequestForm` не принуждает к этому.
> 
> Если оно вам обязательно нужно, то используйте `OAuth2PasswordRequestFormStrict` вместо `OAuth2PasswordRequestForm`.

* Необязательным `client_id` (для нашего примера он нам не нужен).
* Необязательным `client_secret` (для нашего примера он нам не нужен).

> **Для информации**
> 
> `OAuth2PasswordRequestForm` это не специальный класс для FastAPI как `OAuth2PasswordBearer`.
> 
> `OAuth2PasswordBearer` делает для FastAPI известным, что он это схема безопасности. Поэтому он добавил этот способ в OpenAPI.
> 
> Но `OAuth2PasswordRequestForm` это просто класс зависимости, который вы можете написать сами, или можете объявить 
> напрямую параметр `Form`.
> 
> Но так как это часто используемый случай, он предоставлен FastAPI напрямую, просто, чтобы упростить его.

