# CORS (Cross-Origin Resource Sharing)

<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS или "Cross-Origin Resource Sharing"</a> относится
к ситуациям когда фронтенд, запущенный в браузере, имеет код JavaScript, который взаимодействует с бэкендом, но бэкенд 
имеет другой "источник" чем фронтенд.

## Источник

Источник это комбинация протокола (`http`, `https`), домена (`myapp.com`, `localhost`, `localhost.triangolo.com`) и порта
(`80`, `443`, `8080`).

Поэтому, все это различные источники:

* `http://localhost`
* `https://locallhost`
* `http://localhost:8080`

Даже если все они `localhost`, они используют разные протоколы или порты, поэтому, у них разный "источник".

## Шаги

Допустим, у вас есть фронтенд, запущенный в баузере, на `http://localhost:8080` и его JavaScript пытается взаимодействовать
с бэкендом, запущенным на `http://localhost` (так как мы не указываем порт, браузер будет использовать порт `80` по 
умолчанию).

Затем, браузер отправит запрос HTTP `OPTIONS` в бэкенд и если бэк отправляет соответствующе заголовки взаимодействия
авторизации из другого источника (`http://localhost:8080`), тогда браузер позволит JavaScript из фронта, отправить запрос
в бэк.

Чтобы достичь этого, бэкенд должен иметь список "допущенных источников".

В нашем случае, он бы включал в себя `http://localhost:8080` для фронта, чтобы работать корректно.

## Шаблоны

Так же возможно объявить список как `"*"` ("шаблон"), чтобы сообщить, что все в нем разрешено.

Но это позволит только определенные виды взаимодействия, исключая все, что касается учетных данных: Куки, заголовки 
авторизации, вроде тех, что используют Bearer токены и т.д.

Поэтому, чтобы все работало правильно, лучше явно указать допущенные источники.

## Используйте `CORSMiddleware`

Вы можете настроить его в вашем приложении FastAPI, используя `CORSMiddleware`.

* Импортируйте `CORSMiddleware`.
* Создайте список допущенных источников (как строки).
* Добавьте его как "middleware" в ваше приложение FastAPI.

Также вы можете определять позволяет ли ваш бэкенд:

* Учетные данные (Заголовки авторизации, Куки и т.д.).
* Определенные методы HTTP (`POST`, `PUT`) или все из них, с помощью шаблона `"*"`.
* Определенные заголовки HTTP или все сразу с помощью шаблона `"*"`.

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

origins = [
    "http://localhost.tiangolo.com",
    "https://localhost.tiangolo.com",
    "http://localhost",
    "http://localhost:8080",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
async def main():
    return {"message": "Hello World"}
```

Параметры по умолчанию, используемые с помощью реализации `CORSMiddleware`, являются ограничительными, поэтому вам будет 
нужно явно активировать отдельные источники, методы или заголовки, для того чтобы браузерам было разрешено использовать
их в контексте Cross-Domain.

Поддерживаются следующие аргументы:

* `allow_origins` - Список источников, которым следует быть разрешенными, чтобы совершать запросы. Например, [`https://example.org`,
`https://www.example.org`]. Вы можете использовать `["*"]`, чтобы разрешить любой источник.
* `allow_origin_regex` - Строка регулярного выражения для совпадения с источником, который должен быть разрешен, чтобы 
совершать запросы. Например [`https://.*\.example\.org`].
* `allow_methods` - Список HTTP методов, которые должны быть разрешены для запросов. По умолчанию [`GET`]. Вы можете 
использовать `["*"]`, чтобы разрешить все стандартные методы.
* `allow_headers` - Список HTTP заголовков запроса, которые должны поддерживаться запросами. По умолчанию `[]`. Вы можете
использовать `["*"]`, чтобы разрешить любые заголовки. Заголовки `Accept`, `Accept-Language`, `Content-Language` и 
`Content-Type` всегда разрешены для <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests">
простых запросов CORS</a>.
* `allow_credentials` - Показывает, что куки должны поддерживаться запросами. По умолчанию `False`. Также, `allow_origins`
не могут быть установлены на `["*"]`, чтобы разрешить учетные данные, источники должны быть определены.
* `expose_headers` - Показывает любые заголовки запроса, которые должны быть доступны браузеру. По умолчанию `[]`.
* `max_age` - Устанавливает максимальное время в секундах для браузеров, чтобы кешировать запросы CORS. По умолчанию `600`.

Middleware отвечает на два конкретных типа HTTP запроса...

### Запросы CORS preflight

Это любой запрос `OPTIONS` с заголовками `Origin` и `Access-Control-Request-Method`.

В этом случае, middleware перехватит входящий запрос и ответит соответствующими заголовками CORS, и в целях информации 
ответит либо `200`, либо `400`.

### Простые запросы

Любой запрос с заголовком `Origin`. В этом случае, middleware передаст запрос, как обычно, но включит в ответ 
соответствующие заголовки CORS.

## Больше информации

Для большей информации про CORS, посмотрите <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">
Mozilla CORS documentation</a>.

> **Технические детали**
> 
> Вы можете так же использовать `from starlette.middleware.cors import CORSMiddleware`.
> 
> FastAPI предоставляет несколько middleware в `fastapi.middleware` просто удобнее для вас, разработчика. Но большинство
> доступных middleware приходят напрямую из Starlette.