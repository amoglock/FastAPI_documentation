<h3>Безопасность - первые шаги</h3>

Давайте представим, что у вас есть бэкенд вашего API на каком-то домене.

И есть фронтенд на другом домене или отдельном пути того же домена (или в мобильном приложении).

И вы хотите иметь способ во фронтенде для аутентификации с бэкендом, используя имя пользователя и пароль.

Мы можем использовать OAuth2, чтобы сделать это с FastAPI.

Но давайте сбережем вам время прочтения всей длинной спецификации, просто для того, чтобы найти маленькие частички 
информации которая вам нужна.

Давайте использовать инструменты предоставленные FastAPI, чтобы обрабатывать безопасность.

<h4>Как это выглядит</h4>

Давайте сперва просто использовать код и посмотрим как он работает, а затем вернемся, чтобы понять, что происходит.

<h4>Создайте `main.py`</h4>

Скопируйте пример в файл `main.py`:

```python
from typing import Annotated

from fastapi import Depends, FastAPI
from fastapi.security import OAuth2PasswordBearer

app = FastAPI()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

@app.get("/items/")
async def read_items(token: Annotated[str, Depends(oauth2_scheme)]):
    return {"token": token}
```

<h4>Запустим это</h4>

> **Для информации**
> 
> Сперва установите <a href="https://andrew-d.github.io/python-multipart/">`python-multipart`</a>.
> 
> Например `pip install python-mulptipart`.
> 
> Это потому, что OAuth2 использует "данные формы" для отправки `username` и `password`.

Запустите пример:

```commandline
uvicorn main:app --reload
```

<h4>Проверьте</h4>

Перейдите в интерактивную документацию: <a href="http://127.0.0.1:8000/docs">http://127.0.0.1:8000/docs</a>.

Вы увидите что-то вроде этого:

<img src="https://fastapi.tiangolo.com/img/tutorial/security/image01.png">

> **Кнопка авторизации!**
> 
> У вас уже есть новая, блестящая кнопка "Authorize".
> 
> А у вашей операции пути есть маленький замок в правом верхнем углу, который вы можете кликнуть.

И если вы его нажмете, у вас есть небольшая форма авторизации, чтобы ввести `username` и `password` (и другие 
дополнительные поля):

<img src="https://fastapi.tiangolo.com/img/tutorial/security/image02.png">

> **Заметка**
> 
> Не важно, что вы напечатаете в форме, она пока не будет работать. Но мы доберемся и туда.

Это, конечно, не фронтенд для конечных пользователей, но это отличный автоматический инструмент, чтобы интерактивно 
документировать весь ваш API.

Он может быть использовать командой фронтенда (которая может быть вами же).

Она может быть использована сторонними приложениями и системами.

И она может быть использована вами же, для отладки, проверки и тестирования того же приложения.

<h4>The `password` flow</h4>

Теперь давайте вернемся чуть назад и поймем, что это все такое.

`Password` "flow" это один из способов ("flows") определенных в OAuth2, чтобы обрабатывать безопасность и аутентификацию.

OAuth2 был разработан так, что бэкенд или API могут быть независимыми от сервера, который аутентифицирует пользователя.

Но в таком случае, то же FastAPI приложение будет обрабатывать API и аутентификацию.

Поэтому, давайте рассмотрим его с упрощенной точки зрения:

* Пользователь набирает `username` и `password` в фронтенде и жмет `Enter`.
* Фронт (запущенный в браузере пользователя) отправляет эти `username` и `password` на определенный URL в нашем API
(объявленный с `tokenURL="token"`).
* API проверяет эти `username` и `password`, и отвечает на "token" (пока мы ничего из этого не реализовали).
  * "Token" это просто строка с каким-то содержимым, которое мы можем использовать позже для того, чтобы верифицировать
  этого пользователя.
  * Обычно, токен устанавливается так, чтобы он истекал через какое-то время.
    * Поэтому, позже пользователю нужно будет войти снова в какой-то момент.
    * А если токен украден, риск меньше. Это не постоянный ключ, который будет работать вечно (в большинстве случаев).
* Фронтенд где-то временно хранит этот токен.
* Пользователь нажимает в интерфейсе, чтобы перейти в другой раздел интерфейса веб-приложения.
* Фронтенду нужно получить еще некоторые данные из API.
  * Но ему нужна аутентификация для определенного эндпоинта.
  * Поэтому, чтобы аутентифицироваться с нашим API, он отправляет заголовок `Authorization` со значением `Bearer` плюс токен.
  * Если токен содержит `foobar`, содержимое заголовка `Authorization` было бы: `Bearer foobar`.

